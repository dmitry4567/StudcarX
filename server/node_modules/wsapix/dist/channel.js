"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WsapixChannel = void 0;
const events_1 = require("events");
const util_1 = require("util");
const types_1 = require("./types");
const transport_1 = require("./transport");
class WsapixChannel extends events_1.EventEmitter {
    /**
     * Channel constructor
     * @param path - channel path
     * @param options - channel options
     */
    constructor(path, options) {
        super();
        this.middlewares = [];
        this.hooks = new Map();
        /**
         * connected clients
         */
        this.clients = new Set();
        /**
         * Registered messages
         */
        this.messages = [];
        this.validatePayload = (schema, payload, error) => {
            if (this.validator) {
                return this.validator(schema, payload, (msg) => {
                    error(msg);
                });
            }
            return true;
        };
        if (typeof path === "object") {
            options = path;
            path = path.path;
        }
        this.path = path || "/";
        this.validator = options === null || options === void 0 ? void 0 : options.validator;
        this.messages = (options === null || options === void 0 ? void 0 : options.messages) || [];
        this._parser = (options === null || options === void 0 ? void 0 : options.parser) || "json";
        this._serializer = (options === null || options === void 0 ? void 0 : options.serializer) || "json";
    }
    on(event, listener) {
        return super.on(event, listener);
    }
    /**
     * Channel parser
     */
    get parser() {
        return this._parser === "json" ? JSON.parse : this._parser || ((data) => data);
    }
    /**
     * Channel serializer
     */
    get serializer() {
        return this._serializer === "json" ? JSON.stringify : this._serializer || ((data) => data);
    }
    /**
     * Register connection hook
     * @param middleware - connection hook
     */
    use(middleware) {
        this.middlewares.push(middleware);
    }
    /**
     * Register message hook
     * @param type - type of hook
     *
     * @param hook - hook handler
     */
    addHook(type, hook) {
        const hooks = this.hooks.get(type);
        if (!hooks) {
            this.hooks.set(type, [hook]);
        }
        else {
            this.hooks.set(type, [...hooks, hook]);
        }
    }
    runHook(type, client, data) {
        return __awaiter(this, void 0, void 0, function* () {
            for (const hook of this.hooks.get(type) || []) {
                const asyncHook = util_1.promisify(hook);
                data = yield asyncHook(client, data);
            }
            return data;
        });
    }
    onConnect(client) {
        return __awaiter(this, void 0, void 0, function* () {
            const _send = client.send.bind(client);
            client.send = (data, cb) => __awaiter(this, void 0, void 0, function* () {
                try {
                    // execute hooks
                    if (this.validator !== undefined) {
                        // preValidation hook
                        data = yield this.runHook("preValidation", client, data);
                        const message = this.findServerMessage(data);
                        if (!message) {
                            const error = new Error("Cannot send message: Message schema not found");
                            cb && cb(error);
                            return Promise.reject(error);
                        }
                        let errorMessage = "";
                        if (message.schema && !this.validatePayload(message.schema.payload, data, (msg) => {
                            errorMessage = msg;
                            cb && cb(new Error(msg));
                        })) {
                            return Promise.reject(new Error("Cannot send message - payload validation error:\n" + errorMessage));
                        }
                    }
                    // preSerialization hook
                    data = yield this.runHook("preSerialization", client, data);
                    // encode message
                    data = this.serializer(data);
                    // preSend hook
                    data = yield this.runHook("preSerialization", client, data);
                    return _send(data, cb);
                }
                catch (error) {
                    cb && cb(error);
                    return Promise.reject(error);
                }
            });
            // execute midllwares
            for (const middleware of this.middlewares) {
                try {
                    yield middleware(client);
                }
                catch (error) {
                    throw error;
                }
                if (client.status === transport_1.ClientStatus.disconnecting || client.status === transport_1.ClientStatus.disconnected) {
                    return;
                }
            }
            this.clients.add(client);
            client.channel = this;
            this.emit("connect", client);
        });
    }
    onMessage(client, data) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                // onMessage hook
                data = yield this.runHook("onMessage", client, data);
                // preParse hook
                data = yield this.runHook("preParse", client, data);
                try {
                    data = this.parser(data);
                }
                catch (error) {
                    this.emit("error", client, "Unexpected message payload", data);
                    return;
                }
                const message = this.findClientMessage(data);
                if (!message) {
                    this.emit("error", client, "Message not found", data);
                    return;
                }
                const { handler, schema } = message;
                if (!handler) {
                    this.emit("error", client, `Handler not implemented`, data);
                    return;
                }
                if (schema && this.validator !== undefined) {
                    data = yield this.runHook("preValidation", client, data);
                    if (!this.validatePayload(schema.payload, data, (msg) => {
                        this.emit("error", client, msg, data);
                    })) {
                        return;
                    }
                }
                data = yield this.runHook("preHandler", client, data);
                handler(client, data);
            }
            catch (error) {
                this.emit("error", client, "Unhandled error", data);
            }
        });
    }
    onDisconnect(client, code, data) {
        this.clients.delete(client);
        this.emit("disconnect", client, code, data);
    }
    serverMessage(matcher, schema) {
        this.messages.push({ kind: types_1.MessageKind.server, matcher, schema });
    }
    clientMessage(matcher, schema, handler) {
        if (typeof schema === "function") {
            handler = schema;
            schema = undefined;
        }
        this.messages.push({ kind: types_1.MessageKind.client, matcher, handler, schema });
    }
    /**
     * Find client message by payload
     * @param data - payload
     * @returns Message or undefined
     */
    findClientMessage(data) {
        return this.findMessage(types_1.MessageKind.client, data);
    }
    /**
     * Find server message by payload
     * @param data - message payload
     * @returns Message or undefined
     */
    findServerMessage(data) {
        return this.findMessage(types_1.MessageKind.server, data);
    }
    inherit(channel) {
        // set default channel parameters
        this._parser = this._parser || channel.parser;
        this._serializer = this._serializer || channel.serializer;
        this.validator = this.validator || channel.validator;
        // add middlwares and messages
        if (channel.path === "*") {
            this.middlewares = [...channel.middlewares, ...this.middlewares];
            this.messages.push(...channel.messages);
        }
        // forward events
        this.on("error", (client, data) => channel.emit("error", client, data));
        this.on("disconnect", (client) => channel.emit("disconnect", client));
    }
    findMessage(type, data) {
        return this.messages.find((msg) => {
            if (msg.kind !== type) {
                return false;
            }
            if (typeof msg.matcher === "function") {
                return msg.matcher(data);
            }
            else {
                let fields = Object.keys(msg.matcher).length;
                for (const key of Object.keys(msg.matcher)) {
                    fields -= data[key] === msg.matcher[key] ? 1 : 0;
                }
                return fields === 0;
            }
        });
    }
}
exports.WsapixChannel = WsapixChannel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbm5lbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jaGFubmVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLG1DQUFxQztBQUNyQywrQkFBZ0M7QUFFaEMsbUNBR2dCO0FBRWhCLDJDQUEwQztBQXNCMUMsTUFBYSxhQUF1QixTQUFRLHFCQUFZO0lBOER0RDs7OztPQUlHO0lBQ0gsWUFBWSxJQUFpQyxFQUFFLE9BQTJCO1FBQ3hFLEtBQUssRUFBRSxDQUFBO1FBbkVELGdCQUFXLEdBQTBCLEVBQUUsQ0FBQTtRQUN2QyxVQUFLLEdBQWlDLElBQUksR0FBRyxFQUFFLENBQUE7UUFFdkQ7O1dBRUc7UUFDSSxZQUFPLEdBQXlCLElBQUksR0FBRyxFQUFFLENBQUE7UUFDaEQ7O1dBRUc7UUFDSSxhQUFRLEdBQW9CLEVBQUUsQ0FBQTtRQW1SM0Isb0JBQWUsR0FBRyxDQUFDLE1BQVcsRUFBRSxPQUFZLEVBQUUsS0FBNkIsRUFBVyxFQUFFO1lBQ2hHLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDbEIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtvQkFDN0MsS0FBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2dCQUNiLENBQUMsQ0FBQyxDQUFBO2FBQ0g7WUFDRCxPQUFPLElBQUksQ0FBQTtRQUNiLENBQUMsQ0FBQTtRQWhPQyxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUM1QixPQUFPLEdBQUcsSUFBSSxDQUFBO1lBQ2QsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUE7U0FDakI7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxHQUFHLENBQUE7UUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsU0FBUyxDQUFBO1FBQ25DLElBQUksQ0FBQyxRQUFR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