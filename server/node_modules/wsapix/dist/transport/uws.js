"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.uWebsocketTransport = exports.uWebSocketClient = void 0;
const transport_1 = require("./transport");
class uWebSocketClient extends transport_1.Client {
    constructor(ws) {
        super();
        this.ws = ws;
        this.path = ws.url;
        this.headers = ws.headers;
        this.query = ws.query;
    }
    _send(data, cb) {
        this.ws.send(data, false, false);
        return Promise.resolve(cb && cb());
    }
    _terminate(code, data) {
        this.ws.end(code, data);
    }
}
exports.uWebSocketClient = uWebSocketClient;
class uWebsocketTransport extends transport_1.Transport {
    constructor(options) {
        super();
        this.clients = new WeakMap();
        const { server } = options, wsOptions = __rest(options, ["server"]);
        this.app = server;
        this.app.ws('/*', Object.assign(Object.assign({}, wsOptions), { upgrade: (res, req, context) => {
                // get all headers
                const headers = {};
                req.forEach((key, value) => headers[key] = value);
                const upgradeParams = {
                    url: req.getUrl(),
                    query: req.getQuery(),
                    headers,
                    connection: {
                        remoteAddress: Buffer.from(res.getRemoteAddressAsText()).toString()
                    }
                };
                /* This immediately calls open handler, you must not use res after this call */
                /* Spell these correctly */
                res.upgrade(upgradeParams, req.getHeader('sec-websocket-key'), req.getHeader('sec-websocket-protocol'), req.getHeader('sec-websocket-extensions'), context);
            }, open: (ws) => __awaiter(this, void 0, void 0, function* () {
                const client = new uWebSocketClient(ws);
                this.clients.set(ws, client);
                client.status = transport_1.ClientStatus.connected;
                this.handlers.connection(client);
            }), close: (ws, code, message) => {
                const client = this.clients.get(ws);
                client.status = transport_1.ClientStatus.disconnecting;
                this.handlers.disconnect(client, code, Buffer.from(message.slice(0)).toString());
                client.status = transport_1.ClientStatus.disconnected;
            }, message: (ws, message, isBinary) => {
                const client = this.clients.get(ws);
                this.handlers.message(client, Buffer.from(message.slice(0)).toString());
            } }));
    }
    close(cb) {
        return Promise.resolve(cb && cb());
    }
}
exports.uWebsocketTransport = uWebsocketTransport;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXdzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RyYW5zcG9ydC91d3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSwyQ0FBNkQ7QUFTN0QsTUFBYSxnQkFBaUIsU0FBUSxrQkFBTTtJQUUxQyxZQUFtQixFQUFhO1FBQzlCLEtBQUssRUFBRSxDQUFBO1FBRFUsT0FBRSxHQUFGLEVBQUUsQ0FBVztRQUU5QixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUE7UUFDbEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFBO1FBQ3pCLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQTtJQUN2QixDQUFDO0lBRU0sS0FBSyxDQUFDLElBQVMsRUFBRSxFQUE0QjtRQUNsRCxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2pDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUNwQyxDQUFDO0lBRU0sVUFBVSxDQUFDLElBQWEsRUFBRSxJQUFhO1FBQzVDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUN6QixDQUFDO0NBQ0Y7QUFqQkQsNENBaUJDO0FBRUQsTUFBYSxtQkFBb0IsU0FBUSxxQkFBUztJQUloRCxZQUFZLE9BQW9EO1FBQzlELEtBQUssRUFBRSxDQUFBO1FBSEYsWUFBTyxHQUF5QyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBS2xFLE1BQU0sRUFBRSxNQUFNLEtBQW1CLE9BQU8sRUFBckIsU0FBUyxVQUFLLE9BQU8sRUFBbEMsVUFBd0IsQ0FBVSxDQUFBO1FBQ3hDLElBQUksQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFBO1FBRWpCLElB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