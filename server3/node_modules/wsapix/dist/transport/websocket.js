"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebsocketTransport = exports.WebsocketClient = void 0;
const ws_1 = __importDefault(require("ws"));
const transport_1 = require("./transport");
const promiseCallback = (resolve, reject, cb) => {
    return (error) => {
        cb && cb(error);
        if (error) {
            return reject(error);
        }
        return resolve();
    };
};
class WebsocketClient extends transport_1.Client {
    constructor(ws, req) {
        super();
        this.ws = ws;
        const [path, query] = (req.url || "").split("?");
        this.path = path;
        this.query = query;
        this.headers = req.headers;
    }
    _send(data, cb) {
        return new Promise((resolve, reject) => {
            this.ws.send(data, promiseCallback(resolve, reject, cb));
        });
    }
    _terminate(code, reason) {
        this.ws.close(code, reason);
    }
}
exports.WebsocketClient = WebsocketClient;
class WebsocketTransport extends transport_1.Transport {
    constructor(options) {
        super();
        this.wss = new ws_1.default.Server(options);
        this.wss.on("connection", (ws, req) => {
            const client = new WebsocketClient(ws, req);
            ws.on("close", (code, data) => {
                client.status = transport_1.ClientStatus.disconnecting;
                this.handlers.disconnect(client, code, data);
                client.status = transport_1.ClientStatus.disconnected;
            });
            ws.on("message", (data) => this.handlers.message(client, data));
            client.status = transport_1.ClientStatus.connected;
            this.handlers.connection(client);
        });
        this.wss.on("error", this.handlers.error.bind(this));
    }
    close(cb) {
        return new Promise((resolve, reject) => {
            this.wss.close(promiseCallback(resolve, reject, cb));
        });
    }
}
exports.WebsocketTransport = WebsocketTransport;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RyYW5zcG9ydC93ZWJzb2NrZXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsNENBQTBCO0FBRTFCLDJDQUE2RDtBQUU3RCxNQUFNLGVBQWUsR0FBRyxDQUFDLE9BQThCLEVBQUUsTUFBMkIsRUFBRSxFQUE0QixFQUFFLEVBQUU7SUFDcEgsT0FBTyxDQUFDLEtBQWEsRUFBRSxFQUFFO1FBQ3ZCLEVBQUUsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDZixJQUFJLEtBQUssRUFBRTtZQUFFLE9BQU8sTUFBTSxDQUFFLEtBQUssQ0FBQyxDQUFBO1NBQUU7UUFDcEMsT0FBTyxPQUFPLEVBQUUsQ0FBQTtJQUNsQixDQUFDLENBQUE7QUFDSCxDQUFDLENBQUE7QUFFRCxNQUFhLGVBQWdCLFNBQVEsa0JBQU07SUFFekMsWUFBb0IsRUFBYSxFQUFFLEdBQW9CO1FBQ3JELEtBQUssRUFBRSxDQUFBO1FBRFcsT0FBRSxHQUFGLEVBQUUsQ0FBVztRQUUvQixNQUFNLENBQUUsSUFBSSxFQUFFLEtBQUssQ0FBRSxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDbEQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUE7UUFDaEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFDbEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFBO0lBQzVCLENBQUM7SUFFUyxLQUFLLENBQUMsSUFBUyxFQUFFLEVBQTRCO1FBQ3JELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDMUQsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRVMsVUFBVSxDQUFDLElBQWEsRUFBRSxNQUFZO1FBQzlDLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUM3QixDQUFDO0NBQ0Y7QUFuQkQsMENBbUJDO0FBRUQsTUFBYSxrQkFBbUIsU0FBUSxxQkFBUztJQUcvQyxZQUFZLE9BQWlDO1FBQzNDLEtBQUssRUFBRSxDQUFBO1FBQ1AsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLFlBQVMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDeEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUMsRUFBYSxFQUFFLEdBQW9CLEVBQUUsRUFBRTtZQUNoRSxNQUFNLE1BQU0sR0FBRyxJQUFJLGVBQWUsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUE7WUFDM0MsRUFBRSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFLLEVBQUUsSUFBSyxFQUFFLEVBQUU7Z0JBQzlCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsd0JBQVksQ0FBQyxhQUFhLENBQUE7Z0JBQzFDLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7Z0JBQzVDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsd0JBQVksQ0FBQyxZQUFZLENBQUE7WUFDM0MsQ0FBQyxDQUFDLENBQUE7WUFDRixFQUFFLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQVMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUE7WUFFcEUsTUFBTSxDQUFDLE1BQU0sR0FBRyx3QkFBWSxDQUFDLFNBQVMsQ0FBQTtZQUN0QyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNsQyxDQUFDLENBQUMsQ0FBQTtRQUVGLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtJQUN0RCxDQUFDO0lBRU0sS0FBSyxDQUFDLEVBQTRCO1FBQ3ZDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUN0RCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRjtBQTNCRCxnREEyQkMifQ==